app.controller('HomeCtrl', ['$scope', '$http', '$routeParams', '$location', 'UserServices', function($scope, $http, $routeParams, $location, UserServices){

  $scope.pins = [];
  $scope.likes = [];
  $scope.loaded = false;
  $scope.category_url = ''; //might need to clean up
  $scope.changing = false;
  $scope.user = UserServices;
  $scope.searchTerms = '';
  $scope.loaded = false;
  $scope.open = false;

  var pinsHash = {};
  var likesHash = {};

  var url = '';
  var category_url = '';
  var searchTerms_url = '';
  var limit = 18;
  var offset = 0;
  var end = false;
 
  // FUNCTION DEFINITIONS
  // set the search url
  $scope.setURL = function() {
    // then this is a user page
    if ($location.path() === "/profile") { url = 'likes.json?'; }  
    // else not a user page, get all pins
    else { url = 'pins.json?'; }  
    url += 'limit=' + limit + '&offset=' + offset;
    url += category_url;

    if ($scope.searchTerms != "") {
      searchTerms_url = '&keyword=' + $scope.searchTerms;
    } else {
      searchTerms_url = '';
    }
    // add our search terms to the url
    url += searchTerms_url;
  }

  var hashLikes = function() {
    for (j = 0; j < $scope.likes.length; j++) {
      likesHash[$scope.likes[j].id] = true;
    }
  }

  var comparePins = function() {
    for (i = 0; i < $scope.pins.length; i++) {
      if (likesHash[$scope.pins[i].id]) {
        $scope.pins[i].liked_by_me = true;
      }
    }
  }

  $scope.searchPins = function() {
    // new search - set offset to 0
    offset = 0;
    $scope.setURL();
    console.log("About to search: ", url);

    $http.get(url).success(function(data){
      $scope.pins = data.pins;
      $scope.loaded = true;
      hashLikes();
      comparePins();
      if ($scope.pins.count < limit) {
        end = true;
      }      
    }).error(function(response){
      console.log(">>>>> ERROR IN searchPINS ", response);
    });
  }
  
  // inifinite scroll function
  $scope.nextPage = function() {
    if ($scope.busy) return;
    if (end == true) return;
    offset += limit;
    $scope.busy = true;
    $scope.setURL();
    //console.log("About to next page with url: ", url);
    $http.get(url).success(function(data){
      var numPins = data.pins.length;
      if (numPins < limit){
        end = true;
      }
      for(var i = 0; i < numPins; i++) {
        if (likesHash[data.pins[i].id]) {
          data.pins[i].liked_by_me = true;
        }
        $scope.pins.push(data.pins[i]);
      }
      $scope.busy = false;
    });
  }

  // Zoom in and out part
  $scope.openPin = function(pin_id, liked){
    //console.log(pin_id);
    $http.get('pins/' + pin_id + '.json').success(function(data){
      $scope.pin = data.pins[0];
      $scope.pin.liked_by_me = liked;
    })
    $scope.open = !$scope.open;
  }

  $scope.closePin = function(){
    console.log("here in close Pin");
    //$scope.pin = null;
    $scope.open = false;
    //$scope.open = !$scope.open;
  }

  $scope.unlikePin = function(index) {
    var pinID = $scope.pins[index].id;
    
    $http.delete('/likes/'+ pinID).success(function(data){
      if ($location.path() != '/profile') {
        $scope.pins[index].liked_by_me = false;
      }
    }).error(function(response){
      console.log("error in unlikePin ", response);
    })
    $http.patch('/unlikePin/' + pinID).success(function(data){
      console.log("unliked pin : ", data);
    })
  }

  $scope.likePin = function(index) {
    var pinID = $scope.pins[index].id;

    //console.log("ABOUT TO LIKE PIN ID: ", pinID);
    $http.post('/likes/' + pinID).success(function(data){
      $scope.pins[index].liked_by_me = true;
    }).error(function(response){
      console.log("error in likePin ", response);
    })
    $http.patch('/likePin/' + pinID).success(function(data){
      console.log("liked pin : ", data);
    })
  }

  $scope.likePinToggle = function(index) {
    console.log("IN PIN TOGGLE INDEX: ", index);
    var liked = $scope.pins[index].liked_by_me;
    // if first time using this variable - set it
    if (typeof liked === 'undefined') { liked = false; }    
    if (liked) {
      $scope.unlikePin(index);
      $scope.pins[index].like_count--;
      // remove from array if not on home page
      if ($location.path() == '/profile') {
        console.log('on profile page');
        $scope.pins.splice(index, 1);
      }
    } else { 
      $scope.likePin(index);
      $scope.pins[index].like_count++;
    }
  }


  // THIS IS STUFF THAT GETS CALLED AUTOMATICALLY
  $scope.setURL();

  $http.get('/categories.json').success(function(data){
    $scope.categories = data.categories;
  })

  $http.get('/likes.json').success(function(data){
    console.log("getting likes :", data);
    $scope.likes = data.pins;
  })

  if($routeParams.category) {
    $http.get('categories/' + $routeParams.category + '.json').success(function(response) {
      category_url = "&category_id=" + response.id;
      url += $scope.category_url;
      $scope.searchPins();
    })
    .error(function(response){
      console.log(">>>>> error in get category");
    });
  } else {
    category_url = '';
    // if we have no category in the url, get some pins and get more with infinite scroll as you scroll
    $scope.busy = false;
    $scope.after = '';
    $scope.searchPins();
  }


}])
