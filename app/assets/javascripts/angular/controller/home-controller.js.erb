app.controller('HomeCtrl', ['$scope', '$http', '$routeParams', function($scope, $http, $routeParams){

  $scope.searchTerms = '';
  $scope.category = '';
  $scope.limit = 24; // limit = the number of pins each get requests retrieve
  $scope.offset = 0; // the number of times it does loadMore, for inifinity scroll
    
  var url = '';

  $scope.search = function() {
    // had trouble when categoryID was nil
    if ($scope.category) { 
      url = 'pins.json?keyword=' + $scope.searchTerms +'&category_id=' + $scope.category.id;
    } else {
      url = 'pins.json?keyword=' + $scope.searchTerms;
    }
    $http.get(url).success(function(response){
      //console.log("doing a search - ", categoryId);
      $scope.pins = response.pins;
      //console.log($scope.pins);
      //$('#masonry-container').masonry();
      //console.log("just ran masonry");
    })
  }
  
  $http.get('/categories.json').success(function(data){
    $scope.categories = data.categories;
  })

  // if there is a category in the url
  if ($routeParams.category) {
    // we know we have selected a category, per angular-config
    // lets find the id with a get request
    $http.get('/categories.json?keyword='+$routeParams.category).success(function(response) {
      console.log("response ", response.categories[0]);
      $scope.category = response.categories[0];
      categoryId = $scope.category.id
      // and now search to get results in this category
      $scope.search();
    }).error(function(response){
      console.log("error in get category");
    })
  } else {
    // if we have no category in the url, get all

    

    $http.get('pins.json?limit=' + $scope.limit + '&offset=' + $scope.offset).success(function(data){
      $scope.pins = data.pins;
      console.log('pins with offset ', $scope.offset, ': ', $scope.pins);
    });
    $scope.busy = false;
    $scope.after = '';
  }

  $scope.nextPage = function() {
    if ($scope.busy) return;
    $scope.busy = true;
    $scope.offset += $scope.limit;
    $http.get('pins.json?limit=' + $scope.limit + '&offset=' + $scope.offset).success(function(data){
      console.log('pins with offset ', $scope.offset, ': ', data.pins);
      for(var i = 0; i <= $scope.limit-1; i++) {
        $scope.pins.push(data.pins[i]);
      }
      $scope.busy = false;
    });
  }

  // $scope.loadMore = function() {
  //   offset += limit;
  //   console.log('loadmore', offset);
  //   $http.get('pins.json?limit=' + limit + '&offset=' + offset).success(function(data){
  //     for(var i = 0; i <= limit-1; i++) {
  //       $scope.pins.push(data.pins[i]);
  //     }
  //   });
  //   $('#masonry-container').masonry();
  // };

  // Zoom in and out part
  $scope.open = false;
  $scope.openPin = function(pin_id){
    console.log(pin_id);
    $http.get('pins/' + pin_id + '.json').success(function(data){
      console.log(data);
      $scope.pin = data.pins[0];
    })
    $scope.open = !$scope.open;
    console.log('click');
  }
  $scope.closePin = function(){
    $scope.open = !$scope.open;
  }


  $scope.whatever = function(){
    console.log('whatever works!');
    $http.get('pins.json').success(function(data){
      $scope.pins.unshift(data.pins[1]);
    });
  }

}])
